#!/usr/bin/env Rscript
if (!('./data' %in% list.dirs(recursive = FALSE))) {
  cat('This must be run in the root of the data owners repository.\n')
  quit(status = 1)
}

library(ggplot2)
library(scales)
library(stringr)

DOMAIN = 'http://dataowners.thomaslevine.com/'

owner.responses <- read.csv('/tmp/dataowners.csv', stringsAsFactors = TRUE)
data.owners <- read.csv('data/for-analysis.csv', stringsAsFactors = FALSE)

sent.messages <- read.csv('data/sent-messages.csv', stringsAsFactors = FALSE)
sent.messages$hash <- str_replace(str_match(sent.messages$message, paste0(DOMAIN, '([^/]+)'))[,1], DOMAIN, '')
sent.messages$sent <- sent.messages$notes == '' | grepl('messages.py', sent.messages$notes)
sent.messages <- sent.messages[!(sent.messages$hash == 'babccd6fc133ad7f51fb5ae658f9e051' & !sent.messages$sent),] # Remove the only duplicate.
sent.messages$dataset <- sent.messages$message <- sent.messages$notes <- NULL

cube <- merge(merge(sent.messages[c('hash', 'sent')],
                    owner.responses,
                    by = 'hash', all.x = TRUE, all.y = FALSE),
              data.owners, by.x = 'hash', by.y = 'owner.hash',
              all.x = TRUE, all.y = FALSE)
.levels <- c('yes', 'no', 'could not send', 'no response')
cube$result <- factor(cube$answer, levels = .levels)
cube$result[is.na(cube$result)] <- ifelse(cube$sent[is.na(cube$result)], 'no response', 'could not send')
levels(cube$result) <- c('Yes', 'No', 'Could not send', 'No response')
row.names(cube) <- cube$hash
cube$hash <- cube$answer <- cube$sent <- NULL
cube$owner.id <- factor(cube$owner.id,
                        levels = cube$owner.id[order(cube$n.datasets)])

sent <- subset(cube, result != 'Could not send')

cube$sent <- cube$result
levels(cube$sent) <- c('Yes','Yes','Yes','No')
p1 <- ggplot(cube) + aes(x = sent) + geom_bar() +
        scale_x_discrete('Did I manage to send the message?') +
        scale_y_continuous('Number of people') +
        ggtitle(paste('Of the',
                      nrow(cube),
                      'people whom I sampled,\nI manage to contact',
                      nrow(sent),
                      paste0('(', round(100*nrow(sent)/nrow(cube)), '%)')))

p2 <- ggplot(sent) +
        aes(x = owner.id, y = n.datasets, fill = result) +
        geom_bar(stat = 'identity') +
        coord_flip() +
        ylim(0, 100) +
        ggtitle('I asked each of these people whether\nhe or she was the appropriate contact person.') +
        scale_x_discrete(paste('I contacted these',
                               nrow(sent),
                               'people')) +
        scale_y_continuous('Number of datasets that the person owned') +
        scale_fill_discrete('Response')

p3 <- ggplot(sent) + aes(x = n.datasets) + geom_histogram(binwidth = 10) +
        facet_wrap(~ result, ncol = 1) +
        scale_x_continuous('Number of datasets') +
        scale_y_continuous('Number of people with this many datasets that provided this particular response') +
        ggtitle('People with more datasets tended not to respond.')
